{"version":3,"sources":["../src/token/client.ts","../src/utils.ts","../src/const.ts","../src/token/format-ext.ts","../src/token/core.ts","../src/pwd/client.ts","../src/pwd/core.ts"],"names":["out","res","asyncPool","request","YuqueClient","client_default","core_default"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,eAAe;AACtB,SAAS,OAAAA,MAAK,eAA+B;;;ACD7C,OAAO,iBAAiB;AACxB,OAAO,aAAa;AAEpB,OAAO,iBAAiB;AACxB,OAAO,qBAAqB;AAC5B,SAAS,KAAK,kBAAkB;;;ACLzB,IAAM,oBAAoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAO1B,IAAM,sBAAsB,CAAC,aAAa,aAAa,WAAW;;;ADAzE,OAAO,eAAe;AAKf,IAAM,WAAW,CAAC,MAAgB,UAA8B;AAZvE;AAaE,MAAI,EAAE,KAAK,IAAI;AACf,MAAI,aAAa;AAAA;AAAA,IAEf,OAAO,KAAK;AAAA;AAAA,IAEZ,SAAS,KAAK;AAAA;AAAA,IAEd,MAAM,WAAW,KAAK,UAAU;AAAA;AAAA,IAEhC,SAAS,WAAW,KAAK,UAAU;AAAA,EACrC;AAEA,OAAI,gBAAK,SAAL,mBAAW,SAAX,mBAAiB,MAAM;AACzB,eAAW,SAAS,KAAK,KAAK,KAAK;AAAA,EACrC;AAEA,MAAI,KAAK,OAAO;AACd,eAAW,QAAQ,KAAK;AAAA,EAC1B;AAEA,OAAI,UAAK,SAAL,mBAAW,QAAQ;AACrB,eAAW,OAAO,KAAK,KAAK,IAAI,CAAC,SAAS,KAAK,KAAK;AAAA,EACtD;AAEA,MAAI,6BAAM,aAAa;AACrB,eAAW,cAAc,6BAAM;AAAA,EACjC;AACA,MAAI;AACF,QAAI,CAAC,OAAO;AAEV,YAAM,QAAQ;AACd,aAAO,KAAK,QAAQ,OAAO,CAAC,MAAM,EAAE,QAAQ,2BAA2B,IAAI,CAAC;AAAA,IAC9E;AACA,UAAM,SAAS,YAAY,IAAI;AAC/B,WAAO,OAAO;AACd,QAAI,aAAqC,OAAO;AAChD,iBAAa,kCACR,aACA;AAGL,WAAO;AAAA,MACL;AAAA,MACA;AAAA,IACF;AAAA,EACF,SAAS,GAAP;AACA,QAAI,QAAQ,8FAA6B,EAAE,OAAO;AAClD,QAAI,QAAQ,mHAA4D;AACxE,QAAI,MAAM,CAAC;AACX,WAAO;AAAA,MACL;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAKO,SAAS,mBAAmB,KAAa;AAE9C,QAAM,MAAM;AACZ,QAAM,OAAO;AACb,QAAM,cAAc;AACpB,QAAM,gBAAgB;AACtB,QAAM,IAAI,QAAQ,KAAK,EAAE,EAAE,QAAQ,MAAM,EAAE,EAAE,QAAQ,eAAe,EAAE,EAAE,QAAQ,aAAa,EAAE;AAC/F,SAAO;AACT;AAMO,SAAS,gBAAgB,KAAuB;AACrD,MAAI,EAAE,MAAM,IAAI,IAAI;AACpB,QAAM,UAAU;AAChB,QAAM,aAAa;AACnB,QAAM,QAAQ;AAEd,QAAM,IAAI,QAAQ,SAAS,MAAM,EAAE,QAAQ,YAAY,UAAU,EAAE,QAAQ,OAAO,IAAI;AACtF,SAAO;AACT;AAMO,SAAS,UAAU,KAAuB;AAC/C,MAAI,EAAE,MAAM,IAAI,IAAI;AACpB,SAAO;AACT;AAKA,IAAM,WAAW;AAAA,EACf;AAAA,IACE,MAAM;AAAA,IACN,SAAS;AAAA,IACT,YAAY;AAAA,MACV,KAAK,CAAC,YAAY;AAAA,MAClB,MAAM;AAAA,IACR;AAAA,IACA,UAAU,CAAC;AAAA,EACb;AAAA,EACA;AAAA,IACE,MAAM;AAAA,IACN,OAAO;AAAA,EACT;AACF;AAEA,IAAM,WAAW,CAAC,SAAc;AAE9B,MAAI,KAAK,SAAS,aAAa,KAAK,YAAY,QAAQ;AACtD,SAAK,SAAS,KAAK,GAAG,QAAQ;AAAA,EAChC;AAEA,MAAI,KAAK,UAAU;AACjB,aAAS,IAAI,GAAG,IAAI,KAAK,SAAS,QAAQ,KAAK;AAC7C,YAAM,QAAQ,KAAK,SAAS,CAAC;AAC7B,eAAS,KAAK;AAAA,IAChB;AAAA,EACF;AACF;AAMA,IAAM,cAAc,CAAC,YAAoB;AACvC,QAAM,eAAe,QAAQ,EAC1B,IAAI,WAAW,EACf,IAAI,MAAM,CAAC,SAAS;AAEnB,aAAS,IAAI;AAAA,EACf,CAAC,EACA,IAAI,eAAe,EAEnB,YAAY,OAAO;AACtB,SAAO,aAAa;AACtB;AAMO,IAAM,iBAAiB,CAAC,SAAiB;AAE9C,MAAI;AACF,WAAO,YAAY,IAAI;AAAA,EACzB,SAAS,GAAP;AACA,QAAI,QAAQ,sEAAoB;AAChC,WAAO;AAAA,EACT;AACF;AAOO,IAAM,UAAU,CAAC,aAAqB;AAC3C,QAAM,YAAY,IAAI,UAAU;AAChC,YAAU,aAAa,iBAAiB;AACxC,QAAM,OAAO,KAAK,IAAI;AACtB,QAAM,SAAS,OAAO,MAAM;AAC5B,SAAO,UAAU,QAAQ,MAAM;AACjC;;;AEnLA,SAAS,OAAAA,YAAW;AACpB,OAAO,UAAU;AAOV,IAAM,YAAN,MAAgB;AAAA,EAIrB,YAAY,QAA0B;AAHtC,qBAA8B;AAI5B,SAAK,YAAY;AACjB,SAAK,MAAM,KAAK,cAAc;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA;AAAA,EAMQ,gBAAmC;AACzC,QAAI,OAAO,KAAK,cAAc,WAAW;AACvC,UAAI,KAAK,WAAW;AAElB,eAAO;AAAA,MACT,OAAO;AAEL,eAAO;AAAA,MACT;AAAA,IACF,WAAW,OAAO,KAAK,cAAc,UAAU;AAC7C,MAAAA,KAAI,QAAQ,gBAAM,8JAA4B;AAC9C,UAAI;AAEF,cAAM,gBAAgB,KAAK,QAAQ,QAAQ,IAAI,GAAG,KAAK,SAAS;AAEhE,cAAM,EAAE,OAAO,IAAI,UAAQ,aAAa;AACxC,eAAO;AAAA,MACT,SAAS,GAAP;AACA,QAAAA,KAAI,IAAI,oGAAoB,EAAE,OAAO;AACrC,QAAAA,KAAI,MAAM,CAAC;AACX,gBAAQ,KAAK,EAAE;AAAA,MACjB;AAAA,IACF,WAAW,OAAO,KAAK,cAAc,YAAY;AAC/C,aAAO,KAAK;AAAA,IACd,OAAO;AACL,MAAAA,KAAI,QAAQ,oHAAqB;AACjC,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKO,eAAe;AACpB,WAAO,KAAK;AAAA,EACd;AACF;;;AHxCA,IAAM,kBAAkB;AAExB,IAAM,cAAN,MAAkB;AAAA,EAMhB,YAAY,QAA8B;AAH1C,mBAA0B,CAAC;AAIzB,SAAK,SAAS;AACd,SAAK,OAAO,QAAQ,OAAO,SAAS,QAAQ,IAAI;AAChD,QAAI,CAAC,KAAK,OAAO,SAAS,CAAC,KAAK,OAAO,QAAQ,CAAC,KAAK,OAAO,OAAO;AACjE,MAAAA,KAAI,IAAI,4BAAQ,kDAAU;AAC1B,MAAAA,KAAI,KAAK,8FAA2D;AACpE,cAAQ,KAAK,EAAE;AAAA,IACjB;AACA,SAAK,YAAY,GAAG,OAAO,SAAS,OAAO;AAC3C,QAAI,OAAO,WAAW;AACpB,YAAM,YAAY,IAAI,UAAU,OAAO,SAAS;AAChD,WAAK,eAAe,UAAU,aAAa;AAAA,IAC7C,OAAO;AACL,WAAK,eAAe;AAAA,IACtB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQM,QAAW,KAAa,SAAyB,QAA8B;AAAA;AACnF,YAAM,EAAE,MAAM,IAAI,KAAK;AACvB,UAAI,UAAU,KAAK,OAAO,WAAW;AACrC,UAAI,QAAQ,SAAS,GAAG,GAAG;AAEzB,kBAAU,QAAQ,MAAM,GAAG,EAAE;AAAA,MAC/B;AACA,YAAM,MAAM,GAAG,WAAW;AAC1B,YAAM,OAAuB;AAAA,QAC3B,SAAS;AAAA,UACP,gBAAgB;AAAA,QAClB;AAAA,SACG;AAEL,UAAI,QAAQ;AACV,cAAMC,OAAM,MAAM,QAAW,KAAK,IAAI;AACtC,eAAOA,KAAI;AAAA,MACb;AACA,YAAM,MAAM,MAAM,QAA0B,KAAK,IAAI;AACrD,UAAI,IAAI,WAAW,KAAK;AAEtB,QAAAD,KAAI,IAAI,GAAG;AAAA,MACb;AACA,aAAO,IAAI,KAAK;AAAA,IAClB;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,SAAS;AAAA;AACb,aAAO,KAAK,QAAwB,SAAS,KAAK,iBAAiB;AAAA,QACjE,QAAQ;AAAA,MACV,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,aAAa;AAAA;AAEjB,WAAK,UAAU,MAAM,KAAK,OAAO;AACjC,YAAM,OAAmB,CAAC;AAC1B,YAAM,OAAO;AACb,YAAM,UAAU,CAAO,SAAS,MAAM;AACpC,cAAM,WAAW;AACjB,cAAM,MAAM,MAAM,KAAK;AAAA,UACrB,SAAS,KAAK;AAAA,UACd;AAAA,YACE,QAAQ;AAAA,YACR,MAAM,EAAE,QAAQ,OAAO,SAAS;AAAA,UAClC;AAAA,UACA;AAAA,QACF;AACA,aAAK,KAAK,GAAG,IAAI,IAAI;AACrB,YAAI,IAAI,KAAK,QAAQ,SAAS,UAAU;AACtC,gBAAM,QAAQ,SAAS,QAAQ;AAAA,QACjC;AAAA,MACF;AACA,YAAM,QAAQ;AACd,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,aAAa,MAAc;AAAA;AAC/B,YAAM,WAAW,MAAM,KAAK,QAAwB,SAAS,KAAK,kBAAkB,QAAQ;AAAA,QAC1F,QAAQ;AAAA,QACR,MAAM,EAAE,KAAK,EAAE;AAAA,MACjB,CAAC;AACD,YAAM,UAAU;AAChB,cAAQ,SAAS,SAAS;AAC1B,YAAM,OAAO,KAAK,QAAQ,KAAK,CAAC,SAAS,KAAK,SAAS,SAAS,IAAI;AACpE,UAAI,MAAM;AACR,YAAI,cAAc,CAAC;AACnB,YAAI,WAAW,KAAK;AACpB,iBAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,GAAG,KAAK;AACvC,gBAAM,UAAU,KAAK,QAAQ,KAAK,CAAC,SAAS,KAAK,SAAS,QAAQ;AAClE,qBAAW,QAAQ;AACnB,gBAAM,UAAsB;AAAA,YAC1B,OAAO,QAAQ;AAAA,YACf,QAAQ,SAAS;AAAA,UACnB;AACA,sBAAY,KAAK,OAAO;AAAA,QAC1B;AACA,gBAAQ,UAAU,YAAY,QAAQ;AAAA,MACxC;AAEA,cAAQ,YAAY,eAAe,QAAQ,SAAS;AACpD,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOM,iBAAiB,YAAwB,KAAe;AAAA;AAC5D,UAAI,cAA2B,CAAC;AAChC,UAAI,OAAO;AACX,UAAI,IAAI,QAAQ;AAEd,eAAO,KAAK,OAAO,CAAC,QAAQ;AAC1B,gBAAM,QAAQ,IAAI,QAAQ,IAAI,IAAI,IAAI;AACtC,cAAI,CAAC,OAAO;AACV,YAAAA,KAAI,KAAK,4BAAQ,IAAI,KAAK;AAAA,UAC5B;AACA,iBAAO;AAAA,QACT,CAAC;AAAA,MACH;AACA,UAAI,EAAC,6BAAM,SAAQ;AACjB,QAAAA,KAAI,OAAO,gBAAM,wDAAW;AAC5B,eAAO;AAAA,MACT;AACA,MAAAA,KAAI,KAAK,4BAAQ,OAAO,KAAK,MAAM,CAAC;AACpC,MAAAA,KAAI,OAAO,yCAAW;AACtB,aAAO,KAAK,IAAI,CAAC,MAAM,UAAW,iCAAK,OAAL,EAAW,QAAQ,QAAQ,EAAE,EAAc;AAC7E,YAAM,UAAU,CAAO,QAAkB;AACvC,QAAAA,KAAI,KAAK,4BAAQ,IAAI,UAAU,KAAK,aAAa,IAAI,KAAK;AAC1D,YAAI,UAAU,MAAM,KAAK,aAAa,IAAI,IAAI;AAC9C,YAAI,CAAC,IAAI,UAAU,oBAAoB,KAAK,CAAC,SAAS,SAAS,QAAQ,MAAM,GAAG;AAC9E,UAAAA,KAAI,QAAQ,gBAAM,SAAI,QAAQ,mEAAiB;AAAA,QACjD;AACA,gBAAQ,gBAAgB,QAAQ;AAEhC,cAAM,EAAE,MAAM,WAAW,IAAI,SAAS,OAAO;AAE7C,YAAI,UAAU,mBAAmB,IAAI;AAErC,kBAAU,KAAK,aAAa,iCAAK,UAAL,EAAc,MAAM,QAAQ,EAAC;AACzD,gBAAQ,aAAa;AAErB,gBAAQ,OAAO;AACf,gBAAQ,UAAU,IAAI,KAAK,QAAQ,UAAU,EAAE,QAAQ;AACvD,oBAAY,KAAK,OAAO;AAAA,MAC1B;AACA,YAAM,UAAU,KAAK,OAAO,SAAS,GAAG,MAAM,OAAO;AACrD,MAAAA,KAAI,KAAK,4BAAQ,OAAO,YAAY,MAAM,CAAC;AAC3C,aAAO;AAAA,IACT;AAAA;AACF;AAEA,IAAO,iBAAQ;;;AI5Lf,SAAS,OAAAA,YAAW;AAQpB,IAAM,iBAAN,MAAqB;AAAA,EAKnB,YAAY,SAA+B;AAF3C,iBAAoB,CAAC;AAGnB,SAAK,SAAS;AACd,SAAK,MAAM,IAAI,eAAY,KAAK,MAAM;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA;AAAA,EAMM,aAAiC;AAAA;AACrC,MAAAA,KAAI,KAAK,6EAAiB;AAC1B,UAAI,QAAQ,MAAM,KAAK,IAAI,WAAW;AAEtC,cAAQ,MACL,OAAO,CAAC,SAAS;AAEhB,YAAI,CAAC,KAAK;AAAQ,iBAAO;AACzB,YAAI,oBAAoB,KAAK,CAAC,SAAS,SAAS,KAAK,MAAM,GAAG;AAC5D,UAAAA,KAAI,QAAQ,gBAAM,SAAI,KAAK,mEAAiB;AAC5C,iBAAO;AAAA,QACT;AACA,eAAO;AAAA,MACT,CAAC,EACA,OAAO,CAAC,SAAS;AAChB,eAAO,KAAK,OAAO,aAAa,CAAC,CAAC,KAAK,SAAS;AAAA,MAClD,CAAC,EACA,OAAO,CAAC,SAAS;AAChB,eAAO,KAAK,OAAO,gBAAgB,CAAC,CAAC,KAAK,SAAS;AAAA,MACrD,CAAC;AACH,WAAK,QAAQ;AACb,MAAAA,KAAI,KAAK,4BAAQ,OAAO,KAAK,MAAM,MAAM,CAAC;AAC1C,aAAO,MAAM,IAAI,CAAC,SAAS;AACzB,cAAM,YAAY,IAAI,KAAK,KAAK,UAAU,EAAE,QAAQ;AACpD,eAAO;AAAA;AAAA,UAEL,IAAI,OAAO,KAAK,EAAE;AAAA,UAClB,QAAQ,KAAK;AAAA,UACb,SAAS;AAAA,QACX;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMM,iBAAiB,KAAe;AAAA;AACpC,aAAO,MAAM,KAAK,IAAI,iBAAiB,KAAK,OAAO,GAAG;AAAA,IACxD;AAAA;AACF;AAEA,IAAO,eAAQ;;;ACnEf,OAAOE,gBAAe;AACtB,SAAS,OAAAF,MAAK,WAAAG,gBAA+B;AAI7C,SAAS,aAAa;AAKtB,IAAM,eAAe;AAErB,IAAMC,eAAN,MAAkB;AAAA,EAShB,YAAY,QAA4B;AALxC,kBAAiB;AACjB,mBAAsB,CAAC;AACvB,mBAA0B,CAAC;AAIzB,SAAK,SAAS;AACd,SAAK,OAAO,WAAW,OAAO,YAAY,QAAQ,IAAI;AACtD,SAAK,OAAO,WAAW,OAAO,YAAY,QAAQ,IAAI;AACtD,QAAI,CAAC,KAAK,OAAO,YAAY,CAAC,KAAK,OAAO,YAAY,CAAC,KAAK,OAAO,SAAS,CAAC,KAAK,OAAO,MAAM;AAC7F,MAAAJ,KAAI,IAAI,4BAAQ,kDAAU;AAC1B,cAAQ,KAAK,EAAE;AAAA,IACjB;AACA,SAAK,YAAY,GAAG,KAAK,OAAO,SAAS,KAAK,OAAO;AACrD,SAAK,UAAU,KAAK,OAAO,QAAQ;AACnC,QAAI,KAAK,QAAQ,SAAS,GAAG,GAAG;AAE9B,WAAK,UAAU,KAAK,QAAQ,MAAM,GAAG,EAAE;AAAA,IACzC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKM,QAAQ;AAAA;AACZ,YAAM,YAAY;AAAA,QAChB,OAAO,KAAK,OAAO;AAAA,QACnB,UAAU,QAAQ,KAAK,OAAO,QAAQ;AAAA,QACtC,WAAW;AAAA,MACb;AAEA,YAAM,MAAM,MAAMG;AAAA,QAChB,GAAG,KAAK;AAAA,QACR;AAAA,UACE,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,SAAS;AAAA,YACP,SAAS,KAAK,UAAU;AAAA,YACxB,QAAQ,KAAK;AAAA,YACb,cACE;AAAA,UACJ;AAAA,QACF;AAAA,MACF;AACA,UAAI,IAAI,WAAW,KAAK;AACtB,QAAAH,KAAI,IAAI,sCAAQ;AAEhB,QAAAA,KAAI,IAAI,GAAG;AACX,gBAAQ,KAAK,EAAE;AAAA,MACjB;AACA,UAAI,IAAI,QAAQ,YAAY,GAAG;AAE7B,aAAK,SAAS;AAAA,UACZ,MAAM,KAAK,IAAI;AAAA,UACf,MAAM,IAAI,QAAQ,YAAY;AAAA,QAChC;AAAA,MACF;AACA,MAAAA,KAAI,KAAK,sCAAQ;AAAA,IACnB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQM,QAAW,KAAa,SAAyB,QAA8B;AAAA;AAlFvF;AAmFI,YAAM,MAAM,GAAG,KAAK,WAAW;AAC/B,YAAM,OAAuB;AAAA,QAC3B,SAAS;AAAA,UACP,SAAQ,UAAK,WAAL,mBAAa;AAAA,QACvB;AAAA,SACG;AAEL,UAAI,GAAC,UAAK,YAAL,mBAAc,SAAQ;AACzB,QAAAA,KAAI,IAAI,iCAAQ;AAChB,gBAAQ,KAAK,EAAE;AAAA,MACjB;AACA,UAAI,QAAQ;AACV,cAAMC,OAAM,MAAME,SAAW,KAAK,IAAI;AACtC,eAAOF,KAAI;AAAA,MACb;AACA,YAAM,MAAM,MAAME,SAA0B,KAAK,IAAI;AACrD,UAAI,IAAI,WAAW,KAAK;AAEtB,QAAAH,KAAI,IAAI,GAAG;AAAA,MACb;AACA,aAAO,IAAI,KAAK;AAAA,IAClB;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,SAAS;AAAA;AA7GjB;AA8GI,UAAI;AACF,cAAM,MAAM,MAAM,KAAK,QAAQ,KAAK,WAAW,EAAE,QAAQ,OAAO,UAAU,OAAO,GAAG,IAAI;AACxF,cAAM,MAAM,IAAI,MAAM,GAAG,OAAO,EAAE,YAAY,cAAc,CAAC;AAC7D,cAAM,EAAE,KAAK,MAAI,gCAAK,WAAL,mBAAa,YAAW,CAAC;AAC1C,YAAI,OAAO,MAAM;AACjB,YAAI,CAAC,MAAM;AACT,UAAAA,KAAI,QAAQ,sFAAgB;AAC5B,kBAAQ,KAAK,EAAE;AAAA,QACjB;AACA,aAAK,SAAS,KAAK;AACnB,gBAAO,6BAAM,QAAO,CAAC;AAAA,MACvB,SAAS,GAAP;AACA,QAAAA,KAAI,QAAQ,wFAAkB,EAAE,OAAO;AACvC,gBAAQ,KAAK,EAAE;AAAA,MACjB;AAAA,IACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,aAAa;AAAA;AAEjB,WAAK,UAAU,MAAM,KAAK,OAAO;AACjC,YAAM,UAAU,MAAM,KAAK,QAAoB,YAAY;AAAA,QACzD,QAAQ;AAAA,QACR,MAAM,EAAE,SAAS,KAAK,OAAO;AAAA,MAC/B,CAAC;AACD,WAAK,UAAU;AACf,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA;AAAA,EAKM,aAAa,MAAc;AAAA;AAC/B,YAAM,iBAAiB,MAAM,KAAK;AAAA,QAChC,GAAG,KAAK,aAAa;AAAA,QACrB;AAAA,UACE,QAAQ;AAAA,UACR,MAAM;AAAA,YACJ,YAAY;AAAA,YACZ,WAAW;AAAA,YACX,QAAQ;AAAA,YACR,WAAW,KAAK,OAAO;AAAA,UACzB;AAAA,UACA,UAAU;AAAA,QACZ;AAAA,QACA;AAAA,MACF;AACA,YAAM,MAAM,KAAK,QAAQ,KAAK,CAAC,SAAS,KAAK,SAAS,IAAI;AAC1D,YAAM,UAAU;AAAA,QACd,MAAM;AAAA,QACN,QAAQ;AAAA,QACR,SAAS,CAAC;AAAA,SACP;AAEL,YAAM,OAAO,KAAK,QAAQ,KAAK,CAAC,SAAS,KAAK,QAAQ,IAAI;AAC1D,UAAI,MAAM;AACR,YAAI,cAAc,CAAC;AACnB,YAAI,WAAW,KAAK;AACpB,iBAAS,IAAI,GAAG,IAAI,KAAK,OAAO,KAAK;AACnC,gBAAM,UAAU,KAAK,QAAQ,KAAK,CAAC,SAAS,KAAK,SAAS,QAAQ;AAClE,qBAAW,QAAQ;AACnB,gBAAM,UAAsB;AAAA,YAC1B,OAAO,QAAQ;AAAA,YACf,QAAQ;AAAA,UACV;AACA,sBAAY,KAAK,OAAO;AAAA,QAC1B;AACA,gBAAQ,UAAU,YAAY,QAAQ;AAAA,MACxC;AACA,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOM,iBAAiB,YAAwB,KAAe;AAAA;AAC5D,UAAI,cAA2B,CAAC;AAChC,UAAI,OAAO;AACX,UAAI,IAAI,QAAQ;AAEd,eAAO,KAAK,OAAO,CAAC,QAAQ;AAC1B,gBAAM,QAAQ,IAAI,QAAQ,IAAI,IAAI,IAAI;AACtC,cAAI,CAAC,OAAO;AACV,YAAAA,KAAI,KAAK,4BAAQ,IAAI,KAAK;AAAA,UAC5B;AACA,iBAAO;AAAA,QACT,CAAC;AAAA,MACH;AACA,UAAI,EAAC,6BAAM,SAAQ;AACjB,QAAAA,KAAI,OAAO,gBAAM,wDAAW;AAC5B,eAAO;AAAA,MACT;AACA,MAAAA,KAAI,KAAK,4BAAQ,OAAO,KAAK,MAAM,CAAC;AACpC,MAAAA,KAAI,OAAO,yCAAW;AACtB,aAAO,KAAK,IAAI,CAAC,MAAM,UAAW,iCAAK,OAAL,EAAW,QAAQ,QAAQ,EAAE,EAAc;AAC7E,YAAM,UAAU,CAAO,QAAkB;AACvC,QAAAA,KAAI,KAAK,4BAAQ,IAAI,UAAU,KAAK,aAAa,IAAI,KAAK;AAC1D,YAAI,UAAU,MAAM,KAAK,aAAa,IAAI,IAAI;AAC9C,YAAI,CAAC,IAAI,UAAU,oBAAoB,KAAK,CAAC,SAAS,SAAS,QAAQ,MAAM,GAAG;AAC9E,UAAAA,KAAI,QAAQ,gBAAM,SAAI,QAAQ,mEAAiB;AAAA,QACjD;AAEA,cAAM,EAAE,MAAM,WAAW,IAAI,SAAS,SAAS,IAAI;AAEnD,gBAAQ,aAAa;AACrB,gBAAQ,OAAO;AACf,gBAAQ,gBAAgB;AACxB,gBAAQ,UAAU,IAAI,KAAK,QAAQ,UAAU,EAAE,QAAQ;AACvD,oBAAY,KAAK,OAAO;AAAA,MAC1B;AACA,YAAME,WAAU,KAAK,OAAO,SAAS,GAAG,MAAM,OAAO;AACrD,MAAAF,KAAI,KAAK,4BAAQ,OAAO,YAAY,MAAM,CAAC;AAC3C,aAAO;AAAA,IACT;AAAA;AACF;AAEA,IAAOK,kBAAQD;;;ACnOf,SAAS,OAAAJ,YAAW;AAOpB,IAAM,eAAN,MAAmB;AAAA,EAKjB,YAAY,SAA6B;AAFzC,iBAAoB,CAAC;AAGnB,SAAK,SAAS;AACd,SAAK,MAAM,IAAIK,gBAAY,KAAK,MAAM;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA,EAKM,QAAQ;AAAA;AACZ,YAAM,KAAK,IAAI,MAAM;AAAA,IACvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMM,aAAiC;AAAA;AACrC,MAAAL,KAAI,KAAK,6EAAiB;AAC1B,UAAI,QAAQ,MAAM,KAAK,IAAI,WAAW;AAEtC,cAAQ,MACL,OAAO,CAAC,SAAS;AAEhB,YAAI,CAAC,KAAK;AAAQ,iBAAO;AACzB,YAAI,oBAAoB,KAAK,CAAC,SAAS,SAAS,KAAK,MAAM,GAAG;AAC5D,UAAAA,KAAI,QAAQ,gBAAM,SAAI,KAAK,mEAAiB;AAC5C,iBAAO;AAAA,QACT;AACA,eAAO;AAAA,MACT,CAAC,EACA,OAAO,CAAC,SAAS;AAChB,eAAO,KAAK,OAAO,aAAa,CAAC,CAAC,KAAK,SAAS;AAAA,MAClD,CAAC,EACA,OAAO,CAAC,SAAS;AAChB,eAAO,KAAK,OAAO,gBAAgB,CAAC,CAAC,KAAK,SAAS;AAAA,MACrD,CAAC;AACH,WAAK,QAAQ;AACb,MAAAA,KAAI,KAAK,4BAAQ,OAAO,KAAK,MAAM,MAAM,CAAC;AAC1C,aAAO,MAAM,IAAI,CAAC,SAAS;AACzB,cAAM,YAAY,IAAI,KAAK,KAAK,UAAU,EAAE,QAAQ;AACpD,eAAO;AAAA;AAAA,UAEL,IAAI,OAAO,KAAK,EAAE;AAAA,UAClB,QAAQ,KAAK;AAAA,UACb,SAAS;AAAA,QACX;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMM,iBAAiB,KAAe;AAAA;AACpC,aAAO,MAAM,KAAK,IAAI,iBAAiB,KAAK,OAAO,GAAG;AAAA,IACxD;AAAA;AACF;AAEA,IAAOM,gBAAQ","sourcesContent":["import asyncPool from 'tiny-async-pool'\nimport { out, request, RequestOptions } from '@elog/shared'\nimport { getProps, processHtmlRaw, processMarkdownRaw, processWordWrap } from '../utils'\nimport {\n  YuQueResponse,\n  DocUnite,\n  YuqueDoc,\n  YuqueDocDetail,\n  YuqueDocProperties,\n  FormatExtFunction,\n  YuqueDocListResponse,\n} from '../types'\nimport { DocDetail, YuqueCatalog, DocCatalog } from '@elog/types'\nimport { FormatExt } from './format-ext'\nimport { YuqueWithTokenConfig } from './types'\nimport { IllegalityDocFormat } from '../const'\n\n/** 默认语雀API 路径 */\nconst DEFAULT_API_URL = 'https://www.yuque.com/api/v2'\n\nclass YuqueClient {\n  config: YuqueWithTokenConfig\n  namespace: string\n  catalog: YuqueCatalog[] = []\n  formatExtCtx: FormatExtFunction\n\n  constructor(config: YuqueWithTokenConfig) {\n    this.config = config\n    this.config.token = config.token || process.env.YUQUE_TOKEN!\n    if (!this.config.token || !this.config.repo || !this.config.login) {\n      out.err('缺少参数', '缺少语雀配置信息')\n      out.info('请查阅Elog配置文档: https://elog.1874.cool/notion/write-platform')\n      process.exit(-1)\n    }\n    this.namespace = `${config.login}/${config.repo}`\n    if (config.formatExt) {\n      const formatExt = new FormatExt(config.formatExt)\n      this.formatExtCtx = formatExt.getFormatExt()\n    } else {\n      this.formatExtCtx = processWordWrap\n    }\n  }\n\n  /**\n   * send api request to yuque\n   * @param api\n   * @param reqOpts\n   * @param custom\n   */\n  async request<T>(api: string, reqOpts: RequestOptions, custom?: boolean): Promise<T> {\n    const { token } = this.config\n    let baseUrl = this.config.baseUrl || DEFAULT_API_URL\n    if (baseUrl.endsWith('/')) {\n      // 删除最后一个斜杠\n      baseUrl = baseUrl.slice(0, -1)\n    }\n    const url = `${baseUrl}/${api}`\n    const opts: RequestOptions = {\n      headers: {\n        'X-Auth-Token': token,\n      },\n      ...reqOpts,\n    }\n    if (custom) {\n      const res = await request<T>(url, opts)\n      return res.data\n    }\n    const res = await request<YuQueResponse<T>>(url, opts)\n    if (res.status !== 200) {\n      // @ts-ignore\n      out.err(res)\n    }\n    return res.data.data\n  }\n\n  /**\n   * 获取目录\n   */\n  async getToc() {\n    return this.request<YuqueCatalog[]>(`repos/${this.namespace}/toc`, {\n      method: 'GET',\n    })\n  }\n\n  /**\n   * 获取文章列表(不带详情)\n   */\n  async getDocList() {\n    // 获取目录信息\n    this.catalog = await this.getToc()\n    const list: YuqueDoc[] = []\n    const self = this\n    const getList = async (offset = 0) => {\n      const pageSize = 100 // 设置分页大小为100\n      const res = await self.request<YuqueDocListResponse>(\n        `repos/${this.namespace}/docs`,\n        {\n          method: 'GET',\n          data: { offset, limit: pageSize },\n        },\n        true,\n      )\n      list.push(...res.data)\n      if (res.meta.total > offset + pageSize) {\n        await getList(offset + pageSize)\n      }\n    }\n    await getList()\n    return list\n  }\n\n  /**\n   * 获取文章详情\n   */\n  async getDocDetail(slug: string) {\n    const yuqueDoc = await this.request<YuqueDocDetail>(`repos/${this.namespace}/docs/${slug}`, {\n      method: 'GET',\n      data: { raw: 1 },\n    })\n    const docInfo = yuqueDoc as DocUnite\n    docInfo.doc_id = yuqueDoc.slug\n    const find = this.catalog.find((item) => item.slug === yuqueDoc.slug)\n    if (find) {\n      let catalogPath = []\n      let parentId = find.parent_uuid\n      for (let i = 0; i < find.depth - 1; i++) {\n        const current = this.catalog.find((item) => item.uuid === parentId)!\n        parentId = current.parent_uuid\n        const catalog: DocCatalog = {\n          title: current.title,\n          doc_id: yuqueDoc.slug,\n        }\n        catalogPath.push(catalog)\n      }\n      docInfo.catalog = catalogPath.reverse()\n    }\n    // 处理HTML\n    docInfo.body_html = processHtmlRaw(docInfo.body_html)\n    return docInfo\n  }\n\n  /**\n   * 获取文章详情列表\n   * @param cachedDocs\n   * @param ids\n   */\n  async getDocDetailList(cachedDocs: YuqueDoc[], ids: string[]) {\n    let articleList: DocDetail[] = []\n    let docs = cachedDocs\n    if (ids.length) {\n      // 取交集，过滤不需要下载的page\n      docs = docs.filter((doc) => {\n        const exist = ids.indexOf(doc.slug) > -1\n        if (!exist) {\n          out.info('跳过下载', doc.title)\n        }\n        return exist\n      })\n    }\n    if (!docs?.length) {\n      out.access('跳过', '没有需要下载的文章')\n      return articleList\n    }\n    out.info('待下载数', String(docs.length))\n    out.access('开始下载文档...')\n    docs = docs.map((item, index) => ({ ...item, _index: index + 1 } as YuqueDoc))\n    const promise = async (doc: YuqueDoc) => {\n      out.info(`下载文档 ${doc._index}/${docs.length}   `, doc.title)\n      let article = await this.getDocDetail(doc.slug)\n      if (!doc.format && IllegalityDocFormat.some((item) => item === article.format)) {\n        out.warning('注意', `【${article.title}】为不支持的文档格式`)\n      }\n      article.body_original = article.body\n      // 解析出properties\n      const { body, properties } = getProps(article)\n      // 处理语雀字符串\n      let newBody = processMarkdownRaw(body)\n      // 处理换行/自定义处理\n      newBody = this.formatExtCtx({ ...article, body: newBody })\n      article.properties = properties as YuqueDocProperties\n      // 替换body\n      article.body = newBody\n      article.updated = new Date(article.updated_at).getTime()\n      articleList.push(article)\n    }\n    await asyncPool(this.config.limit || 3, docs, promise)\n    out.info('已下载数', String(articleList.length))\n    return articleList\n  }\n}\n\nexport default YuqueClient\n","import frontMatter from 'front-matter'\nimport unified from 'unified'\nimport { DocUnite, GetProps } from './types'\nimport rehypeParse from 'rehype-parse'\nimport rehypeStringify from 'rehype-stringify'\nimport { out, timeFormat } from '@elog/shared'\nimport { YuQuePwdPublicKey } from './const'\nimport JSEncrypt from 'jsencrypt-node'\n\n/**\n * 生成元数据\n */\nexport const getProps = (page: DocUnite, isPwd?: boolean): GetProps => {\n  let { body } = page\n  let properties = {\n    // 注入title\n    title: page.title,\n    // urlname\n    urlname: page.slug,\n    // 创建时间\n    date: timeFormat(page.created_at),\n    // 更新时间\n    updated: timeFormat(page.updated_at),\n  } as any\n  // 作者\n  if (page.book?.user?.name) {\n    properties.author = page.book.user.name\n  }\n  // 封面\n  if (page.cover) {\n    properties.cover = page.cover\n  }\n  // 标签\n  if (page.tags?.length) {\n    properties.tags = page.tags.map((item) => item.title)\n  }\n  // 描述\n  if (page?.description) {\n    properties.description = page?.description\n  }\n  try {\n    if (!isPwd) {\n      // front matter信息的<br/>换成 \\n\n      const regex = /^---[\\s|\\S]+?---/i\n      body = body.replace(regex, (a) => a.replace(/(<br \\/>|<br>|<br\\/>)/gi, '\\n'))\n    }\n    const result = frontMatter(body)\n    body = result.body\n    let attributes = <Record<string, string>>result.attributes\n    properties = {\n      ...properties,\n      ...attributes,\n    }\n\n    return {\n      body,\n      properties,\n    }\n  } catch (e: any) {\n    out.warning('front-matter解析失败，将返回预定义属性', e.message)\n    out.warning('预定义属性：https://elog.1874.cool/notion/raqyleng501h23p1#预定义属性')\n    out.debug(e)\n    return {\n      body,\n      properties,\n    }\n  }\n}\n\n/**\n * 处理语雀字符串\n */\nexport function processMarkdownRaw(raw: string) {\n  // 处理不可见字符\n  const nul = /\\x00/g\n  const nul1 = /\\u0000/g\n  const emptyAnchor = /<a name=\\\".*?\\\"><\\/a>/g\n  const hiddenContent = /<div style=\"display:none\">[\\s\\S]*?<\\/div>/gi\n  raw = raw.replace(nul, '').replace(nul1, '').replace(hiddenContent, '').replace(emptyAnchor, '')\n  return raw\n}\n\n/**\n * 处理换行\n * @param doc\n */\nexport function processWordWrap(doc: { body: string }) {\n  let { body: raw } = doc\n  const multiBr = /(<br>[\\s\\n]){2}/gi\n  const multiBrEnd = /(<br \\/>[\\n]?){2}/gi\n  const brBug = /<br \\/>/g\n  // 删除语雀特有的锚点\n  raw = raw.replace(multiBr, '<br>').replace(multiBrEnd, '<br />\\n').replace(brBug, '\\n')\n  return raw\n}\n\n/**\n * 不处理\n * @param doc\n */\nexport function noProcess(doc: { body: string }) {\n  let { body: raw } = doc\n  return raw\n}\n\n/**\n * 语雀css文件\n */\nconst cssStyle = [\n  {\n    type: 'element',\n    tagName: 'link',\n    properties: {\n      rel: ['stylesheet'],\n      href: 'http://editor.yuque.com/ne-editor/lake-content-v1.css',\n    },\n    children: [],\n  },\n  {\n    type: 'text',\n    value: '\\n    ',\n  },\n]\n\nconst findHead = (node: any) => {\n  // 如果当前节点是一个 element，而且它的 tagName 是 \"head\"，那么就返回它\n  if (node.type === 'element' && node.tagName === 'head') {\n    node.children.push(...cssStyle)\n  }\n  // 否则，继续递归遍历它的 children 数组\n  if (node.children) {\n    for (let i = 0; i < node.children.length; i++) {\n      const child = node.children[i]\n      findHead(child)\n    }\n  }\n}\n\n/**\n * 处理Html\n * @param content\n */\nconst processHtml = (content: string) => {\n  const processValue = unified()\n    .use(rehypeParse)\n    .use(() => (tree) => {\n      // processTable(tree)\n      findHead(tree)\n    })\n    .use(rehypeStringify)\n    // 开始同步执行解析\n    .processSync(content)\n  return processValue.contents as string\n}\n\n/**\n * 处理语雀的HTML\n * @param html\n */\nexport const processHtmlRaw = (html: string) => {\n  // 给语雀的HTML头部加上css文件\n  try {\n    return processHtml(html)\n  } catch (e) {\n    out.warning('HTML解析失败，将返回原始HTML')\n    return html\n  }\n}\n\n/**\n * 加密\n * @param password\n * @returns\n */\nexport const encrypt = (password: string) => {\n  const encryptor = new JSEncrypt()\n  encryptor.setPublicKey(YuQuePwdPublicKey)\n  const time = Date.now()\n  const symbol = time + ':' + password\n  return encryptor.encrypt(symbol)\n}\n","export const YuQuePwdPublicKey = `-----BEGIN PUBLIC KEY-----\n  MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCfwyOyncSrUTmkaUPsXT6UUdXx\n  TQ6a0wgPShvebfwq8XeNj575bUlXxVa/ExIn4nOUwx6iR7vJ2fvz5Ls750D051S7\n  q70sevcmc8SsBNoaMQtyF/gETPBSsyWv3ccBJFrzZ5hxFdlVUfg6tXARtEI8rbIH\n  su6TBkVjk+n1Pw/ihQIDAQAB\n  -----END PUBLIC KEY-----`\n\nexport const IllegalityDocFormat = ['lakeboard', 'lakesheet', 'laketable']\n","import { FormatExtFunction } from '../types'\nimport { out } from '@elog/shared'\nimport path from 'path'\nimport { noProcess, processWordWrap } from '../utils'\nimport { FormatExtConfig } from './types'\n\n/**\n * 自定义处理器\n */\nexport class FormatExt {\n  formatExt?: FormatExtConfig = true\n  ctx: FormatExtFunction\n\n  constructor(config?: FormatExtConfig) {\n    this.formatExt = config\n    this.ctx = this.initFormatExt()\n  }\n\n  /**\n   * 初始化适配器\n   * @private\n   */\n  private initFormatExt(): FormatExtFunction {\n    if (typeof this.formatExt === 'boolean') {\n      if (this.formatExt) {\n        // 开启默认处理逻辑\n        return processWordWrap\n      } else {\n        // 不处理\n        return noProcess\n      }\n    } else if (typeof this.formatExt === 'string') {\n      out.warning('注意', '正在加载文档处理拓展点，请遵循文档处理拓展点注入规范')\n      try {\n        // 加载拓展点\n        const formatExtPath = path.resolve(process.cwd(), this.formatExt)\n        // 拓展点需要暴露format方法\n        const { format } = require(formatExtPath)\n        return format\n      } catch (e: any) {\n        out.err('文档处理拓展点加载失败，请检查！', e.message)\n        out.debug(e)\n        process.exit(-1)\n      }\n    } else if (typeof this.formatExt === 'function') {\n      return this.formatExt\n    } else {\n      out.warning('文档处理拓展点配置错误，将使用默认逻辑')\n      return processWordWrap\n    }\n  }\n\n  /**\n   * 获取文档处理器\n   */\n  public getFormatExt() {\n    return this.ctx\n  }\n}\n","import type { YuqueDoc } from '../types'\nimport YuqueClient from './client'\nimport { BaseDoc } from '@elog/types'\nimport { out } from '@elog/shared'\nimport { YuqueWithTokenConfig } from './types'\nimport { IllegalityDocFormat } from '../const'\n\n/**\n * Yuque SDK\n * @class\n */\nclass YuqueWithToken {\n  config: YuqueWithTokenConfig\n  ctx: YuqueClient\n  pages: YuqueDoc[] = []\n\n  constructor(options: YuqueWithTokenConfig) {\n    this.config = options\n    this.ctx = new YuqueClient(this.config)\n  }\n\n  /**\n   * list docs of a repo\n   * @return {Promise<DocDetail[]>} return docs\n   */\n  async getDocList(): Promise<BaseDoc[]> {\n    out.info('正在获取文档列表，请稍等...')\n    let pages = await this.ctx.getDocList()\n    // 过滤未发布和公开的文章\n    pages = pages\n      .filter((page) => {\n        // 2023/11/24调整，语雀不再返回format字段\n        if (!page.format) return true\n        if (IllegalityDocFormat.some((item) => item === page.format)) {\n          out.warning('注意', `【${page.title}】为不支持的文档格式`)\n          return false\n        }\n        return true\n      })\n      .filter((page) => {\n        return this.config.onlyPublic ? !!page.public : true\n      })\n      .filter((page) => {\n        return this.config.onlyPublished ? !!page.status : true\n      })\n    this.pages = pages\n    out.info('文档总数', String(this.pages.length))\n    return pages.map((page) => {\n      const timestamp = new Date(page.updated_at).getTime()\n      return {\n        // 暂时只需要返回这些属性\n        id: String(page.id),\n        doc_id: page.slug,\n        updated: timestamp,\n      }\n    })\n  }\n\n  /**\n   * 获取文章详情列表\n   * @param ids 需要下载的doc_id列表\n   */\n  async getDocDetailList(ids: string[]) {\n    return await this.ctx.getDocDetailList(this.pages, ids)\n  }\n}\n\nexport default YuqueWithToken\n","import asyncPool from 'tiny-async-pool'\nimport { out, request, RequestOptions } from '@elog/shared'\nimport { encrypt, getProps } from '../utils'\nimport { YuQueResponse, YuqueDoc, YuqueDocProperties } from '../types'\nimport { DocDetail, YuqueCatalog, DocCatalog } from '@elog/types'\nimport { JSDOM } from 'jsdom'\nimport { YuqueWithPwdConfig, YuqueLogin, YuqueLoginCookie } from './types'\nimport { IllegalityDocFormat } from '../const'\n\n/** 默认语雀API 路径 */\nconst DEFAULT_HOST = 'https://www.yuque.com'\n\nclass YuqueClient {\n  config: YuqueWithPwdConfig\n  namespace: string\n  baseUrl: string\n  bookId: string = ''\n  docList: YuqueDoc[] = []\n  catalog: YuqueCatalog[] = []\n  cookie: YuqueLoginCookie | undefined\n\n  constructor(config: YuqueWithPwdConfig) {\n    this.config = config\n    this.config.username = config.username || process.env.YUQUE_USERNAME!\n    this.config.password = config.password || process.env.YUQUE_PASSWORD!\n    if (!this.config.username || !this.config.password || !this.config.login || !this.config.repo) {\n      out.err('缺少参数', '缺少语雀配置信息')\n      process.exit(-1)\n    }\n    this.namespace = `${this.config.login}/${this.config.repo}`\n    this.baseUrl = this.config.host || DEFAULT_HOST\n    if (this.baseUrl.endsWith('/')) {\n      // 删除最后一个斜杠\n      this.baseUrl = this.baseUrl.slice(0, -1)\n    }\n  }\n\n  /**\n   * 登陆\n   */\n  async login() {\n    const loginInfo = {\n      login: this.config.username,\n      password: encrypt(this.config.password),\n      loginType: 'password',\n    }\n\n    const res = await request<YuQueResponse<YuqueLogin>>(\n      `${this.baseUrl}/api/mobile_app/accounts/login?language=zh-cn`,\n      {\n        method: 'post',\n        data: loginInfo,\n        headers: {\n          Referer: this.baseUrl + '/login?goto=https%3A%2F%2Fwww.yuque.com%2Fdashboard',\n          origin: this.baseUrl,\n          'user-agent':\n            'Mozilla/5.0 (iPhone; CPU iPhone OS 16_6_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/20G81 YuqueMobileApp/1.0.2 (AppBuild/650 Device/Phone Locale/zh-cn Theme/light YuqueType/public)',\n        },\n      },\n    )\n    if (res.status !== 200) {\n      out.err('语雀登陆失败')\n      // @ts-ignore\n      out.err(res)\n      process.exit(-1)\n    }\n    if (res.headers['set-cookie']) {\n      // 保存cookie\n      this.cookie = {\n        time: Date.now(),\n        data: res.headers['set-cookie'] as string,\n      }\n    }\n    out.info('语雀登陆成功')\n  }\n\n  /**\n   * send api request to yuque\n   * @param api\n   * @param reqOpts\n   * @param custom\n   */\n  async request<T>(api: string, reqOpts: RequestOptions, custom?: boolean): Promise<T> {\n    const url = `${this.baseUrl}/${api}`\n    const opts: RequestOptions = {\n      headers: {\n        cookie: this.cookie?.data,\n      },\n      ...reqOpts,\n    }\n    if (!opts.headers?.cookie) {\n      out.err('未登录语雀!')\n      process.exit(-1)\n    }\n    if (custom) {\n      const res = await request<T>(url, opts)\n      return res.data\n    }\n    const res = await request<YuQueResponse<T>>(url, opts)\n    if (res.status !== 200) {\n      // @ts-ignore\n      out.err(res)\n    }\n    return res.data.data\n  }\n\n  /**\n   * 获取目录\n   */\n  async getToc() {\n    try {\n      const res = await this.request(this.namespace, { method: 'get', dataType: 'text' }, true)\n      const dom = new JSDOM(`${res}`, { runScripts: 'dangerously' })\n      const { book } = dom?.window?.appData || {}\n      dom.window.close()\n      if (!book) {\n        out.warning('爬取语雀目录失败，请稍后重试')\n        process.exit(-1)\n      }\n      this.bookId = book.id\n      return book?.toc || []\n    } catch (e: any) {\n      out.warning('爬取语雀目录失败，请稍后重试', e.message)\n      process.exit(-1)\n    }\n  }\n\n  /**\n   * 获取文章列表(不带详情)\n   */\n  async getDocList() {\n    // 获取目录信息\n    this.catalog = await this.getToc()\n    const docList = await this.request<YuqueDoc[]>(`api/docs`, {\n      method: 'GET',\n      data: { book_id: this.bookId },\n    })\n    this.docList = docList\n    return docList\n  }\n\n  /**\n   * 获取文章详情\n   */\n  async getDocDetail(slug: string) {\n    const yuqueDocString = await this.request<string>(\n      `${this.namespace}/${slug}/markdown`,\n      {\n        method: 'GET',\n        data: {\n          attachment: true,\n          latexcode: false,\n          anchor: false,\n          linebreak: this.config.linebreak,\n        },\n        dataType: 'text',\n      },\n      true,\n    )\n    const doc = this.docList.find((item) => item.slug === slug)!\n    const docInfo = {\n      body: yuqueDocString,\n      doc_id: slug,\n      catalog: [] as any[],\n      ...doc,\n    } as any\n    const find = this.catalog.find((item) => item.url === slug)\n    if (find) {\n      let catalogPath = []\n      let parentId = find.parent_uuid\n      for (let i = 0; i < find.level; i++) {\n        const current = this.catalog.find((item) => item.uuid === parentId)!\n        parentId = current.parent_uuid\n        const catalog: DocCatalog = {\n          title: current.title,\n          doc_id: slug,\n        }\n        catalogPath.push(catalog)\n      }\n      docInfo.catalog = catalogPath.reverse()\n    }\n    return docInfo\n  }\n\n  /**\n   * 获取文章详情列表\n   * @param cachedDocs\n   * @param ids\n   */\n  async getDocDetailList(cachedDocs: YuqueDoc[], ids: string[]) {\n    let articleList: DocDetail[] = []\n    let docs = cachedDocs\n    if (ids.length) {\n      // 取交集，过滤不需要下载的page\n      docs = docs.filter((doc) => {\n        const exist = ids.indexOf(doc.slug) > -1\n        if (!exist) {\n          out.info('跳过下载', doc.title)\n        }\n        return exist\n      })\n    }\n    if (!docs?.length) {\n      out.access('跳过', '没有需要下载的文章')\n      return articleList\n    }\n    out.info('待下载数', String(docs.length))\n    out.access('开始下载文档...')\n    docs = docs.map((item, index) => ({ ...item, _index: index + 1 } as YuqueDoc))\n    const promise = async (doc: YuqueDoc) => {\n      out.info(`下载文档 ${doc._index}/${docs.length}   `, doc.title)\n      let article = await this.getDocDetail(doc.slug)\n      if (!doc.format && IllegalityDocFormat.some((item) => item === article.format)) {\n        out.warning('注意', `【${article.title}】为不支持的文档格式`)\n      }\n      // 解析出properties\n      const { body, properties } = getProps(article, true)\n      // 处理换行/自定义处理\n      article.properties = properties as YuqueDocProperties\n      article.body = body\n      article.body_original = body\n      article.updated = new Date(article.updated_at).getTime()\n      articleList.push(article)\n    }\n    await asyncPool(this.config.limit || 3, docs, promise)\n    out.info('已下载数', String(articleList.length))\n    return articleList\n  }\n}\n\nexport default YuqueClient\n","import type { YuqueDoc } from '../types'\nimport YuqueClient from './client'\nimport { BaseDoc } from '@elog/types'\nimport { out } from '@elog/shared'\nimport { YuqueWithPwdConfig } from './types'\nimport { IllegalityDocFormat } from '../const'\n\n/**\n * Yuque SDK\n */\nclass YuqueWithPwd {\n  config: YuqueWithPwdConfig\n  ctx: YuqueClient\n  pages: YuqueDoc[] = []\n\n  constructor(options: YuqueWithPwdConfig) {\n    this.config = options\n    this.ctx = new YuqueClient(this.config)\n  }\n\n  /**\n   * 登陆语雀\n   */\n  async login() {\n    await this.ctx.login()\n  }\n\n  /**\n   * list docs of a repo\n   * @return {Promise<DocDetail[]>} return docs\n   */\n  async getDocList(): Promise<BaseDoc[]> {\n    out.info('正在获取文档列表，请稍等...')\n    let pages = await this.ctx.getDocList()\n    // 过滤未发布和公开的文章\n    pages = pages\n      .filter((page) => {\n        // 2023/11/24调整，语雀不再返回format字段\n        if (!page.format) return true\n        if (IllegalityDocFormat.some((item) => item === page.format)) {\n          out.warning('注意', `【${page.title}】为不支持的文档格式`)\n          return false\n        }\n        return true\n      })\n      .filter((page) => {\n        return this.config.onlyPublic ? !!page.public : true\n      })\n      .filter((page) => {\n        return this.config.onlyPublished ? !!page.status : true\n      })\n    this.pages = pages\n    out.info('文档总数', String(this.pages.length))\n    return pages.map((page) => {\n      const timestamp = new Date(page.updated_at).getTime()\n      return {\n        // 暂时只需要返回这些属性\n        id: String(page.id),\n        doc_id: page.slug,\n        updated: timestamp,\n      }\n    })\n  }\n\n  /**\n   * 获取文章详情列表\n   * @param ids 需要下载的doc_id列表\n   */\n  async getDocDetailList(ids: string[]) {\n    return await this.ctx.getDocDetailList(this.pages, ids)\n  }\n}\n\nexport default YuqueWithPwd\n"]}